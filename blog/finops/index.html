<!doctype html>
<html lang="fr">
  <head>
  <meta charset="utf-8">
<title>Le FinOps - Issif</title>
<meta name="description" content="Ce que j&#39;ai tir√© de mon exp√©rience de FinOps">
<meta name="viewport" content="width=device-width, initial-scale=1">


  <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png?v=1">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png?v=1">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png?v=1">
  <link rel="manifest" href="/favicon/site.webmanifest?v=1">
  
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="theme-color" content="#ffffff">


  <meta name="generator" content="Hugo 0.64.1" />
  <meta itemprop="name" content="Le FinOps">
<meta itemprop="description" content="Ce que j&#39;ai tir√© de mon exp√©rience de FinOps">
<meta itemprop="datePublished" content="2021-06-17T12:00:00&#43;02:00" />
<meta itemprop="dateModified" content="2021-06-17T12:00:00&#43;02:00" />
<meta itemprop="wordCount" content="5755">



<meta itemprop="keywords" content="" />
  <meta property="og:title" content="Le FinOps" />
<meta property="og:description" content="Ce que j&#39;ai tir√© de mon exp√©rience de FinOps" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://thomas.labarussias.fr/blog/finops/" />
<meta property="article:published_time" content="2021-06-17T12:00:00+02:00" />
<meta property="article:modified_time" content="2021-06-17T12:00:00+02:00" />

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Le FinOps"/>
<meta name="twitter:description" content="Ce que j&#39;ai tir√© de mon exp√©rience de FinOps"/>

  

  <link rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/github.min.css">
  
    
      <link rel="stylesheet" href="/css/normalize.css">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway:400,800,900|Source+Sans+Pro:400,700">
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.1.0/css/flag-icon.min.css">
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css">
      <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.9.0/css/all.css" integrity="sha384-i1LQnF23gykqWXg6jxC2ZbCbUMxyw5gLZY6UiUS98LYV5unm8GWmfkIS6jqJfb4E" crossorigin="anonymous">
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.3.5/jquery.fancybox.min.css" />
      
      
      <link rel="stylesheet" href="/css/main.min.e25bd28619877b6db95b4bb0d84aada96f31ca55d4e0ac23b576470df37a8f85.css" integrity="sha256-4lvShhmHe225W0uw2EqtqW8xylXU4KwjtXZHDfN6j4U=">
      <link rel="stylesheet" href="/css/add-on.css">
    
  
  
  
  
  
</head>

  <body>
    
<header id="site-header">
  <nav id="site-nav">
    <h1 class="nav-title">
      <a href="/">
        
          
            Blog
          
        
      </a>
    </h1>
    <menu id="site-nav-menu" class="flyout-menu">
      
        <a href="/" class="link"><i class="fas fa-home">&nbsp;</i>Accueil</a>
      
        <a href="/categories/" class="link"><i class="fas fa-sitemap">&nbsp;</i>Cat√©gories</a>
      
        <a href="https://github.com/issif" class="link"><i class="fas fa-tools">&nbsp;</i>Projets</a>
      
        <a href="/about/" class="link"><i class="fas fa-id-card">&nbsp;</i>A propos</a>
      
        <a href="/contact/" class="link"><i class="far fa-envelope">&nbsp;</i>Contact</a>
      
        <a href="/index.xml" class="link"><i class="fas fa-rss">&nbsp;</i>RSS</a>
      
      
      

    </menu>
    

    
    
    <a href="#site-nav" class="nav-toggle"><i class="fas fa-bars fa-2x"></i></a>
  </nav>
  
  
</header>

    <div id="wrapper">
      <section id="site-intro">
  <a href="/"><img src="/img/main/logo.png" class="circle" width="85px" alt="Pouet" /></a>
  <header>
    
  </header>
  <main>
    <p>Wake me up before you code Go!</p>
  </main>
  
    <footer>
      <ul class="socnet-icons">
        

        <li><a href="//github.com/issif" target="_blank" rel="noopener" title="GitHub" class="fab fa-github"></a></li>








































        <li><a href="/contact" title="Email" class="far fa-envelope"></a></li>
      </ul>
    </footer>
  
</section>
      <main id="site-main">
        <article class="post">
  <header>
  <div class="title">
    
        <h2><a href="/blog/finops/">Le FinOps</a></h2>
    
    
        <p>Ce que j&#39;ai tir√© de mon exp√©rience de FinOps</p>
    
</div>
  <div class="meta">
    <time class="published" datetime="2021-06-17 12:00:00 &#43;0200 CEST">
      17-06-2021
    </time>
    <span class="author">Issif</span>
    
        <p>28 minutes</p>
    
  </div>
</header>

  <section id="socnet-share">
    




  


  </section>
  

  
  <div class="content">
    <h2 id="avant-propos">Avant-propos</h2>
<p>Durant mon exp√©rience professionnelle pr√©c√©dente, j&rsquo;ai exerc√© pendant 3 ans en tant qu&rsquo;expert <strong>FinOps</strong> sur <strong>AWS</strong>. La fonction ayant √©t√© cr√©√©e avec moi, j&rsquo;ai eu toute libert√© pour mettre en place le mod√®le que je souhaitais, avec sa m√©thodologie et ses outils.
Avant d&rsquo;oublier ce que je sais, je me suis dit qu&rsquo;il serait peut-√™tre int√©ressant pour certains que je mette ce qui me reste en t√™te par √©crit, la litt√©rature en fran√ßais se faisant rare d&rsquo;autant plus (si l&rsquo;article pla√Æt, je ferai peut-√™tre une traduction en anglais).</p>
<p>Il m'√©tait √©galement apparu, en discutant avec mes clients et d&rsquo;autres experts, souvent issus d&rsquo;entreprises de conseils, que ma vision pouvait diff√©rer de la leur et de ce qu&rsquo;on trouve g√©n√©ralement dans les articles traitant du sujet. Je pense que cela vient du fait que je suis avant tout un <em>OPS</em>, g√©rant une production et les contraintes inh√©rentes. Mes recommandations et conseils ont toujours eu pour trame de fond une vraie exploitation des plateformes, de leurs performances et disponibilit√©s (travaillant pour un infog√©rant, si la plateforme tombait, c'√©taient mes coll√®gues et moi qui r√©glons les probl√®mes, possiblement en astreinte üòâ ).</p>
<p>N&rsquo;ayant de connaissances avanc√©es et n&rsquo;ayant effectu√© des audits uniquement pour <em>AWS</em>, j&rsquo;utiliserai dans cet article beaucoup de termes et conseils li√©s √† ce <em>Cloud Provider</em>, mais je pense que les √©l√©ments g√©n√©raux sont facilement transposables √† <em>GCP</em> et <em>Azure</em>.</p>
<hr>
<h2 id="sommaire">Sommaire</h2>
<ul>
<li><a href="#avant-propos">Avant-propos</a></li>
<li><a href="#sommaire">Sommaire</a></li>
<li><a href="#d%C3%A9finition">D√©finition</a></li>
<li><a href="#trouver-le-bon-dosage-entre-ha-perfs-et-co%C3%BBts">Trouver le bon dosage entre HA, Perfs et Co√ªts</a>
<ul>
<li><a href="#un-autre-crit%C3%A8re-%C3%A0-prendre-en-compte-la-s%C3%A9curit%C3%A9">Un autre crit√®re √† prendre en compte: la S√©curit√©</a></li>
<li><a href="#ajuster-ses-crit%C3%A8res">Ajuster ses crit√®res</a></li>
</ul>
</li>
<li><a href="#co%C3%BBts-et-mod%C3%A8les-de-facturation">Co√ªts et mod√®les de facturation</a>
<ul>
<li><a href="#les-co%C3%BBts-directs">Les co√ªts Directs</a></li>
<li><a href="#les-co%C3%BBts-indirects">Les co√ªts Indirects</a></li>
</ul>
</li>
<li><a href="#finops-un-processus">FinOps, un processus</a>
<ul>
<li><a href="#un-processus-continue">Un processus continue</a></li>
<li><a href="#un-processus-it%C3%A9ratif">Un processus it√©ratif</a></li>
<li><a href="#un-processus-%C3%A0-complexit%C3%A9-croissante">Un processus √† complexit√© croissante</a></li>
</ul>
</li>
<li><a href="#outillage">Outillage</a></li>
<li><a href="#les-factures">Les Factures</a></li>
<li><a href="#aws-cost-explorertrusted-advisor">AWS Cost Explorer/Trusted Advisor</a></li>
<li><a href="#les-scripts">Les Scripts</a></li>
<li><a href="#saas">SaaS</a></li>
<li><a href="#websites">Websites</a></li>
<li><a href="#sch%C3%A9mas">Sch√©mas</a></li>
<li><a href="#la-m%C3%A9trologie">La M√©trologie</a></li>
<li><a href="#beaucoup-dactions-possibles">Beaucoup d&rsquo;actions possibles</a>
<ul>
<li><a href="#cat%C3%A9goriser-les-actions-%C3%A0-entreprendre">Cat√©goriser les actions √† entreprendre</a></li>
<li><a href="#identifier-et-supprimer-les-g%C3%A2chis">Identifier et supprimer les g√¢chis</a></li>
<li><a href="#utiliser-correctement-les-ressources">Utiliser correctement les ressources</a>
<ul>
<li><a href="#les-ressources-manag%C3%A9es">Les ressources manag√©es</a></li>
<li><a href="#los-et-les-applications">L&rsquo;OS et les Applications</a></li>
<li><a href="#compiler-ses-binaires">Compiler ses binaires</a></li>
</ul>
</li>
<li><a href="#utiliser-les-services-manag%C3%A9s">Utiliser les services manag√©s</a></li>
<li><a href="#mettre-en-place-des-outils-des-proc%C3%A9dures-des-formations">Mettre en place des outils, des proc√©dures, des formations</a></li>
<li><a href="#architecturer-pour-r%C3%A9duire-les-co%C3%BBts">Architecturer pour r√©duire les co√ªts</a></li>
<li><a href="#politiques-de-scale-inout">Politiques de Scale In/Out</a></li>
<li><a href="#r%C3%A9servations--saving-plans">R√©servations / Saving Plans</a></li>
<li><a href="#spot-instances">Spot Instances</a></li>
<li><a href="#organisation-des-comptes">Organisation des comptes</a></li>
</ul>
</li>
<li><a href="#tags">Tags</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
<h2 id="d√©finition">D√©finition</h2>
<p>La premi√®re des t√¢ches est bien entendu de d√©finir le terme de <strong>FinOps</strong> lui-m√™me. Il appara√Æt √©videmment qu&rsquo;il est la contraction de deux termes (comme tous ces <strong>TrucOps</strong> √† la mode üòõ).
Dans notre cas: <strong>Financial</strong> + <strong>Operations</strong>.
Pas tr√®s parlant au demeurant, on s&rsquo;attend plus √† de la comptabilit√© qu'√† de l&rsquo;architecture <em>Cloud</em>.</p>
<p>Voil√† donc ma d√©finition, avec des morceaux en gras et ce, √† dessein:</p>
<blockquote>
<p>Le <strong>FinOps</strong> <strong>analyse les architectures</strong> Cloud et leurs <strong>facturations associ√©es</strong>, afin de d√©gager des <strong>axes de limitations des co√ªts et/ou d‚Äô√©conomie</strong>, en assurant <strong>un niveau de risque faible</strong> et en prenant en compte les <strong>enjeux de l&rsquo;entreprise</strong>.</p>
</blockquote>
<p>Reprenons chacune des parties mises en exergue:</p>
<ul>
<li><strong>analyse les architectures</strong>: Le travail de <em>FinOps</em> est un travail d&rsquo;ing√©nierie avant tout, si on se contente de pointer des lignes dans une feuille <em>Excel</em> pour trouver les services co√ªtant trop chers dans lesquels il faudrait tailler, cela ne marchera pas.</li>
<li><strong>facturations associ√©es</strong>: On enfonce une porte ouverte, mais il va de soit que pour cibler les axes d&rsquo;am√©liorations, il faut savoir quels sont les services qui sont factur√©s et dans quelles mesures (r√©duire de 10% le co√ªt d&rsquo;un service √† $100 reste moins int√©ressant avant que 2% d&rsquo;un service √† $1000, par exemple).</li>
<li><strong>axes de limitations des co√ªts et/ou d‚Äô√©conomie</strong>: La distinction est tr√®s importante √† mon sens. On cherche souvent √† seulement diminuer les co√ªts, mais il faut aussi penser √† faire en sorte de contr√¥ler leurs √©volutions. J&rsquo;ai souvent expliqu√© qu&rsquo;une facture de <em>Cloud Provider</em> qui augmente, ce n&rsquo;est pas forc√©ment anormal ou g√™nant, cela peut juste √™tre la cons√©quence logique de l&rsquo;augmentation de l&rsquo;activit√©. Vous avez plus de trafic, et donc plus de consommation mais surtout plus de chiffre d&rsquo;affaires, ce qui est attendu. L√† o√π √ßa coince c&rsquo;est quand la facture augmente alors que le CA baisse, ou bien que les deux croissent tous deux mais dans des ordres de grandeur tr√®s diff√©rents (co√ªts qui explosent par rapport aux revenus).</li>
<li><strong>un niveau de risque faible</strong>: Quand on met en place des actions <em>FinOps</em>, on pense souvent √† changer les types des Instances (<em>VM</em>), ou √† r√©-architecturer des portions de la plateforme. Il est alors tr√®s important de garder √† l&rsquo;esprit que la plateforme doit assurer un service de m√™me qualit√© (voire plus), et il faut donc √™tre tr√®s prudent dans les choix et leurs mises en place.</li>
<li><strong>enjeux de l&rsquo;entreprise</strong>: Une plateforme <em>Cloud</em> n&rsquo;est apr√®s-tout qu&rsquo;un outil, un moyen de d√©livrer un service, elle s&rsquo;inscrit dans un cadre beaucoup plus vaste √† prendre en compte. Je pense par exemple √† la maturit√© de l&rsquo;entreprise avec les technologies, ou bien aux contraintes l√©gales (<em>PCI-DSS</em>, <em>HADS</em>, etc).</li>
</ul>
<h2 id="trouver-le-bon-dosage-entre-ha-perfs-et-co√ªts">Trouver le bon dosage entre HA, Perfs et Co√ªts</h2>
<p>Fort de cette d√©finition, il convient d√©sormais d&rsquo;expliciter ce qu&rsquo;on vise en faisant du <strong>FinOps</strong>, ce qui va guider nos choix.</p>
<p>Il s&rsquo;agit de trouver le bon dosage entre 3 crit√®res:</p>
<ul>
<li><strong>Haute-disponibilit√©</strong></li>
<li><strong>Performances</strong></li>
<li><strong>Co√ªts</strong></li>
</ul>
<p>Les 3 s&rsquo;influencent bien √©videmment mutuellement.</p>
<p>Par exemples:</p>
<ul>
<li>Si la <strong>HA</strong> est un crit√®res dominante, les co√ªts vont forc√©ment grimper et les performances peuvent baisser <em>(multi-r√©gions, multi-cloud)</em>.</li>
<li>Si on privil√©gie les <strong>performances</strong>, des machines plus grosses seront √† payer mais la <strong>HA</strong> pourra √™tre sacrifi√©e √©galement <em>(j&rsquo;ai eu un client qui faisait tout tourner sur une seule AZ AWS car les latences entre les datacenters AWS avaient un impact sur sa grille de calcul)</em>.</li>
<li>Si on cherche absolument √† baisser les co√ªts, on sacrifiera les <strong>performances</strong> et/ou la <strong>haute-disponibilit√©</strong>.</li>
</ul>
<h3 id="un-autre-crit√®re-√†-prendre-en-compte-la-s√©curit√©">Un autre crit√®re √† prendre en compte: la S√©curit√©</h3>
<p>J&rsquo;ai volontairement omis de rajouter ce 4√®me crit√®re dans la liste pr√©c√©dente, car il est particulier et √† toute son importance. Il impacte potentiellement les 3 autres crit√®res et s&rsquo;inscrit dans une cadre plus important tr√®s souvent impossible √† n√©gliger (<em>PCI-DSS</em>, <em>HADS</em>, etc). Il faut donc veiller √† ce que les recommandations s&rsquo;inscrivent dans les bonnes pratiques de s√©curit√©, voire dans le cadre de la loi.</p>
<h3 id="ajuster-ses-crit√®res">Ajuster ses crit√®res</h3>
<p>Il ressort de tout cela une bonne nouvelle, c&rsquo;est que nous sommes dans le cadre d&rsquo;une plateforme <em>Cloud</em>, qui vient avec ses contraintes mais aussi ses avantages, avec en t√™te de la liste la flexibilit√©.</p>
<p>J&rsquo;ai mentionn√© pr√©c√©demment que tout l&rsquo;art du <em>FinOps</em> √©tait de trouver le bon dosage entre les <em>perfs</em>, la <em>HA</em> et les <em>co√ªts</em>, et ce qu&rsquo;il y a de <em>magique</em> avec le <em>Cloud</em>, c&rsquo;est que ce dosage n&rsquo;est pas vou√© √† √™tre immuable et universel. La souplesse des <em>Cloud Providers</em> permet d&rsquo;ajuster la balance comme on le souhaite et quand on le souhaite.</p>
<p>Voici une liste d'√©l√©ments pouvant amener √† adapter notre choix du ou des crit√®res dominants, avec quelques exemples pour les expliciter:</p>
<ul>
<li><strong>Environnement</strong>: On accorde souvent plus d&rsquo;importance √† la disponibilit√© de l&rsquo;environnement de production qu'√† celui de staging.</li>
<li><strong>P√©riode</strong>: En e-commerce, on mettra le paquet en p√©riode de soldes. Une application de facturation n&rsquo;a besoin d'√™tre gonfl√©e aux st√©ro√Ødes qu&rsquo;en d√©but ou fin de mois, etc.</li>
<li><strong>Criticit√© des donn√©es</strong>: On peut parfois se permettre de perdre du cache, mais pas des donn√©es m√©tier.</li>
<li><strong>Criticit√© de l&rsquo;application</strong>: Un SSO sera central, alors qu&rsquo;un <em>worker</em> qui tombe ne cr√©e que du d√©lai et sa t√¢che sera cens√©e √™tre reprise ensuite.</li>
<li><strong>Enjeux Business</strong>: Respect des SLA de disponibilit√© ou de performance.</li>
<li><strong>Budget</strong>: Une lev√©e de fond permet souvent d&rsquo;apporter les modifications voulues ou √† l&rsquo;inverse, un trou dans la tr√©sorerie imposera de sacrifier tel ou tel crit√®re.</li>
</ul>
<h2 id="co√ªts-et-mod√®les-de-facturation">Co√ªts et mod√®les de facturation</h2>
<p>Il est extr√™mement important d&rsquo;avoir √† l&rsquo;esprit de quoi sont compos√©es les factures mais aussi le contexte global dans lesquelles elles s&rsquo;inscrivent.</p>
<p>Je d√©gage donc 2 axes, les co√ªts <em>Directs</em> et les co√ªts <em>Indirects</em>.</p>
<p>On ne pourra pas jouer sur les deux de la m√™me fa√ßon, voire pas du tout pour certains √©l√©ments. Et il est tr√®s important de tous les prendre en compte dans les choix des actions √† mener.</p>
<h3 id="les-co√ªts-directs">Les co√ªts Directs</h3>
<p>Je classe parmi les co√ªts <em>Directs</em> tout ce qui est directement dans la facture du <em>Cloud Provider</em>, en s√©parant en 2 cat√©gories:</p>
<ul>
<li><strong>Ressources</strong>: Ce sont les co√ªts dans les factures les plus simples √† comprendre et estimer, g√©n√©ralement factur√©s √† la seconde ou heure, ils caract√©risent les √©l√©ments &ldquo;immobilis√©s&rdquo; pour composer l&rsquo;infrastructure (<em>Instances</em>, <em>Volumes</em>, etc). La r√®gle est simple, plus on prend gros, plus on paye cher, et inversement. On peut donc facilement estimer les √©conomies possibles quand on agit sur elles.</li>
<li><strong>Consommations</strong>: Ce sont tous les co√ªts dans les factures plus difficiles √† estimer car ind√©pendant de nos propres choix et variant du tout ou tout entre les p√©riodes. On y classe la bande passante, les snapshots, le nombre total de requ√™tes, etc. Les estimations d'√©conomies sont souvent moins pr√©cises mais en connaissant bien son activit√© et en prenant quelques marges, on y arrive.</li>
</ul>
<h3 id="les-co√ªts-indirects">Les co√ªts Indirects</h3>
<p>Quand on pense √† r√©duire sa facture <em>Cloud</em> on oublie bien souvent les co√ªts annexes qui n&rsquo;apparaissent pas √† proprement parl√© sur la facture mais qui sont pourtant bien l√† quand on veut mettre en place des actions:</p>
<ul>
<li><strong>Co√ªts de migration</strong>: Si vous pr√©voyez de remplacer des morceaux ou de partir sur une nouvelle architecture, il sera n√©cessaire de passer un grand nombre de <em>JH</em> (jour-homme) sur le sujet, et cela aura un co√ªt pour votre organisation, tant financier qu&rsquo;humain. Le retour sur investissements se doit donc d'√™tre int√©ressant.</li>
<li><strong>Co√ªts de d√©veloppement</strong>: Dans la m√™me id√©e, moins <em>OPS</em> et plus <em>DEV</em>, si vous changez de technologie, il y aura s√ªrement du code √† √©crire et donc du <em>JH</em> √† passer, sur des fonctionnalit√©s qui n&rsquo;apportent pas forc√©ment une plus-value pour le client final.</li>
<li><strong>Formation</strong>: Un point √† ne jamais n√©gliger, tout changement sera mieux v√©cu s&rsquo;il est accompagn√© par une formation, qu&rsquo;elle soit interne ou non (c&rsquo;est souvent plus cher avec des consultants ext√©rieurs, bien entendu).</li>
<li><strong>Infog√©rance</strong>: Si vous ne g√©rez pas vous-m√™me votre plateforme, ou si vous avez souscrit un contrat pour avoir du 24/7, le p√©rim√®tre financier peut √™tre impact√©.</li>
<li><strong>Licences</strong>: C&rsquo;est un point surtout valable pour les migrations d&rsquo;<em>On-Premise</em> vers du <em>Cloud</em>, les mod√®les de facturation des licences √©diteurs pouvant beaucoup changer, et pas forc√©ment √† la baisse.</li>
</ul>
<p>Ces co√ªts <em>Indirects</em> sont bien souvent plus difficiles √† √©valuer, voire quasi impossibles quand vous √™tes un auditeur externe, mais il est important de prendre en compte le fait qu&rsquo;ils existent et peuvent drastiquement changer le choix des actions √† mener.</p>
<h2 id="finops-un-processus">FinOps, un processus</h2>
<p>Maintenant que nous avons la destination, voyons le chemin. A mon sens, le <em>FinOps</em> est un processus qui se d√©roulera toute la vie de la plateforme et d√©bute √† sa conception. Il appara√Æt bien souvent que r√©fl√©chir √† une architecture en int√©grant les aspects <em>FinOps</em> d√®s le d√©but, am√®ne √† cr√©er des conceptions plus proches des bonnes pratiques.</p>
<p>Ce processus √† plusieurs caract√©ristiques, il est:</p>
<ul>
<li><em>Continue</em></li>
<li><em>It√©ratif</em> (une action apr√®s l&rsquo;autre)</li>
<li><em>A complexit√© croissante</em> (voire exponentielle)</li>
</ul>
<p>Ce processus, peut varier d&rsquo;une entreprise √† l&rsquo;autre, mais on retrouve g√©n√©ralement 3 √©tapes cl√©s, se r√©p√©tant:</p>
<blockquote>
<p>Analyse &gt; Recommandations &gt; Mise en place &gt; Analyse &gt; &hellip;</p>
</blockquote>
<h3 id="un-processus-continue">Un processus continue</h3>
<p>Les architectures <em>Cloud</em> √©tant √©lastiques, les facturations associ√©es le sont tout autant. A cela s&rsquo;ajoute que le tout virtualis√©, pay√© √† la consommation, rend les architectures mutables (changement de types de machines, remplacement de briques par d&rsquo;autres services, etc). Il appara√Æt alors √©vident que mener des actions <em>FinOps</em> une fois tous les trimestres, par exemple, sera moins pertinent, et pire, √† la tra√Æne vis-√†-vis des d√©penses.</p>
<p>Il est important d&rsquo;int√©grer le <em>FinOps</em> parmi tous les autres processus permettant de g√©rer correctement une plateforme, voire m√™me d&rsquo;int√©grer des points de contr√¥le au m√™me titre que nous mettons en place du <em>monitoring</em> pour les syst√®mes eux-m√™mes. Les <em>Cloud Providers</em> ne s&rsquo;y sont pas tromp√©s et fournissent des moyens de v√©rifier le respect d&rsquo;un budget (sans jamais bloquer les possibles d√©penses, on parle juste d&rsquo;alertes). Cela rentre dans la partie de ma d√©finition: <code>limiter les co√ªts</code>.</p>
<p>Cela n'√©carte pas les audits plus profonds pouvant √™tre men√©s, non pas au jour le jour, mais tout de m√™me r√©guli√®rement, et qui eux servent souvent √† d√©gager les axes d'√©conomies plus importantes.</p>
<h3 id="un-processus-it√©ratif">Un processus it√©ratif</h3>
<p>Une fois qu&rsquo;une analyse <em>FinOps</em> a √©t√© men√©e √† bien et que des pr√©conisations ont √©t√© √©tablies, la tentation de r√©duire la facture imm√©diatement peut √™tre forte en menant toutes les actions d&rsquo;un coup. C&rsquo;est rarement une bonne chose. En menant plusieurs actions en parall√®le, il devient plus difficile de d√©terminer quelles sont celles qui ont eu l&rsquo;effet escompt√©, et pire, certaines peuvent entrer en contradiction sans qu&rsquo;il ne soit possible de d√©terminer comment. En it√©rant, action par action, il devient ais√© de d√©terminer celles qui ont bien fonctionn√© et donc de les r√©p√©ter dans le temps ou sur d&rsquo;autres environnements.</p>
<h3 id="un-processus-√†-complexit√©-croissante">Un processus √† complexit√© croissante</h3>
<p>La premi√®re action (cf suite de l&rsquo;article) est g√©n√©ralement de traquer les d√©penses inutiles, les g√¢chis. C&rsquo;est une action relativement simple, qu&rsquo;on peut faire manuellement dans un premier temps puis automatis√©e. Une fois que c&rsquo;est en place, d&rsquo;autres actions peuvent √™tre men√©es, forc√©ment plus compliqu√©es que les pr√©c√©dentes, et ainsi de suite. Il appara√Æt rapidement que le rapport √©conomies possibles sur investissement (temps + argent) s&rsquo;amenuise avec le temps, plus on avance dans les solutions trouv√©es pour limiter les co√ªts ou √©conomiser, plus celles-ci deviennent complexes √† mettre en oeuvre. Je pense m√™me que la tendance suivie est exponentielle. L&rsquo;ordre de grandeur de l&rsquo;investissement n&rsquo;est pas du tout le m√™me entre une automatisation de la suppression des volumes d√©tach√©s et la refonte d&rsquo;une partie de l&rsquo;infrastructure pour utiliser du <em>Serverless</em>.</p>
<h2 id="outillage">Outillage</h2>
<p>Avec quoi pouvons-nous mener une analyse <em>FinOps</em>?</p>
<p>Il s&rsquo;agit bien entendu d&rsquo;une liste non exhaustive, mais c&rsquo;est une demande qui m&rsquo;a souvent √©t√© fa√Æte donc la voici.</p>
<h2 id="les-factures">Les Factures</h2>
<p>Les factures sont, bien entendu, les premi√®res pi√®ces √† √©tudier, elles sont souvent simplifi√©es et permettent d&rsquo;avoir un aper√ßu global ainsi que les tendances. C&rsquo;est aussi ce que re√ßoit votre service comptabilit√© (√ßa aidera pour communiquer avec eux, pour lui expliquer les possibles pics ou autres quand c&rsquo;est n√©cessaire).</p>
<h2 id="aws-cost-explorertrusted-advisor">AWS Cost Explorer/Trusted Advisor</h2>
<p>AWS fournit 2 outils:</p>
<ul>
<li><strong>Cost Explorer</strong>: Cela va √™tre votre nouvel meilleur ami. L&rsquo;outil s&rsquo;am√©liore d&rsquo;ann√©e en ann√©e et vous permet d&rsquo;analyser et de mettre en graphique tout votre historique de d√©penses, de filtrer par tags, service, r√©gion, etc. C&rsquo;est vraiment un indispensable et il faut vraiment apprendre √† s&rsquo;en servir. La difficult√© est de comprendre ce qu&rsquo;on lit, car contrairement aux factures, les d√©tails se basent sur l&rsquo;API AWS et non une simplification des termes comme dans les factures re√ßues en fin de mois.</li>
<li><strong>Trusted Advisor</strong>: Lorsque vous souscrivez au support de niveau <strong>Business</strong>, en plus de donner de bonnes informations li√©es √† la s√©curit√© de votre plateforme, l&rsquo;outil vous donne des informations sur les g√¢chis financiers pr√©sents dans le compte. La n√©cessit√© d&rsquo;avoir un haut niveau de support pour que ce soit actif peut √™tre contraignant mais heureusement, les √©l√©ments donn√©s sont relativement simples √† obtenir √† la main ou via script.</li>
</ul>
<h2 id="les-scripts">Les Scripts</h2>
<p>Il existe une pl√©thore de scripts voire d&rsquo;applications compl√®tes sur le web pour aider √† analyser ses co√ªts et trouver les axes d&rsquo;am√©lioration. Vous pouvez √©galement √©crire vos propres scripts pour mettre en avant des points pr√©cis li√©s √† votre infrastructure. L&rsquo;avantage de l&rsquo;automatisation est bien entendu de vous faire gagner du temps mais surtout de pouvoir avoir des r√©sultats r√©guliers et donc de suivre les r√©sultats de vos modifications.</p>
<p>Voici quelques exemples (les deux premiers sont de moi):</p>
<ul>
<li><a href="https://github.com/claranet/go-s3-describe">go-s3-describe</a></li>
<li><a href="https://github.com/claranet/aws-inventory-graph">aws-inventory-graph</a></li>
<li><a href="https://github.com/mlabouardy/komiser">komiser</a></li>
</ul>
<p>Et une recherche sur Github avec quelques autres outils: <a href="https://github.com/search?q=finops+aws&amp;type=Repositories">R√©sultats</a></p>
<h2 id="saas">SaaS</h2>
<p>L&rsquo;engouement pour le <em>FinOps</em> vient forc√©ment avec son lot de services en ligne pour aider dans la t√¢che, en voici deux que j&rsquo;ai test√©s (je ne ferai pas de comparatif, n&rsquo;y ayant pas touch√© depuis longtemps maintenant):</p>
<ul>
<li><a href="https://www.cloudhealthtech.com/">Cloudhealth</a></li>
<li><a href="https://cloudcheckr.com/">Cloudcheckr</a></li>
</ul>
<p>Ces outils font plus que du <em>FinOps</em>, mais comme leurs co√ªts rentrent dans ce que j&rsquo;appelle les co√ªts <em>Indirects</em>, il faut donc les prendre en compte dans vos calculs pour estimer les √©conomies.</p>
<h2 id="websites">Websites</h2>
<p>Le web fourmille de documentations et d&rsquo;articles comme celui-ci, il ne faudra pas h√©siter √† chercher des heures durant pour apprendre les techniques en vogue pour limiter les co√ªts ou m√™me d√©coder la documentation AWS parfois absconde.</p>
<p>Voici un exemple d&rsquo;outils que l&rsquo;on peut trouver et utiliser fr√©quemment:</p>
<ul>
<li><a href="https://Instances.vantage.sh">https://Instances.vantage.sh</a></li>
<li><a href="https://calculator.aws/#/">https://calculator.aws/#/</a> (calculateur officiel fourni par <em>AWS</em>)</li>
<li><a href="https://observablehq.com/@rustyconover/aws-ec2-spot-Instance-simulator">https://observablehq.com/@rustyconover/aws-ec2-spot-Instance-simulator</a></li>
</ul>
<h2 id="sch√©mas">Sch√©mas</h2>
<p>Le <em>FinOps</em> est un travail technique, m√™me si on √©pluche bien les factures, il est int√©ressant d&rsquo;avoir la vision de la plateforme en terme d&rsquo;architecture. Comprendre comment les choses sont pens√©es, de l&rsquo;Instance aux services manag√©s. Le nec plus ultra √©tant d&rsquo;avoir √©galement les flux r√©els et pas juste un sch√©ma de principe, les flux √©tant souvent tr√®s difficiles √† cat√©goriser et encore plus √† comprendre niveau facturation.</p>
<p>Voici un sch√©ma de quelques flux avec les sens pour lesquels AWS vous facture:</p>



  
    
    
    
    
  
  
  
  
  
  
  
  
  <div class="fancybox">
    <a data-fancybox="Screenshot" href="/img/2021/06/aws-flux.png" data-caption="Flux AWS"><img src="/img/2021/06/aws-flux.png"></a>
    <div class="caption">Flux AWS</div>
  </div>


<h2 id="la-m√©trologie">La M√©trologie</h2>
<p>Tous les <em>Cloud Providers</em> fournissent leurs propres solutions de m√©trologie, plus ou moins avanc√©e. Dans le cas d&rsquo;AWS, la solution s&rsquo;appelle <em>Cloudwatch</em>. Bien que pratiques, il est n√©cessaire, pour √©valuer le bon usage des ressources, d&rsquo;avoir son propre syst√®me de m√©trologie, avec une granularit√© plus fine, mais surtout plus de m√©triques.
Prenons le cas de l&rsquo;utilisation CPU, qui est certes rarement un facteur limitant sur des services Web, l&rsquo;utilisation de la m√©moire ou les IO √©tant plus √† suivre. Vous n&rsquo;avez aucune information sur les contextes d&rsquo;ex√©cution (<em>user</em>, <em>system</em>, <em>steal</em>, <em>iowait</em>, &hellip;).
Dans le cas de la RAM, votre <em>Cloud Provider</em> ne vous fournira pas de d√©tails sur son utilisation, difficile de juger en l'√©tat de la pertinence de sa taille pour vos besoins.</p>
<h2 id="beaucoup-dactions-possibles">Beaucoup d&rsquo;actions possibles</h2>
<p>La liste suivante d&rsquo;actions cat√©goris√©es <em>FinOps</em> ne se veut absolument pas compl√®te, chaque service ayant ses sp√©cificit√©s et les mod√®les de facturation √©voluant aussi dans le temps. Encore une fois, m√™me si tr√®s orient√© <em>AWS</em>, elles sont tout ou en partie transposables √† d&rsquo;autres <em>Cloud Providers</em>.</p>
<h3 id="cat√©goriser-les-actions-√†-entreprendre">Cat√©goriser les actions √† entreprendre</h3>
<p>Afin de pouvoir mieux √©valuer les pertinences des actions pr√©conis√©es mais aussi de pouvoir les prioriser, j&rsquo;ai pris l&rsquo;habitude de les cat√©goriser selon 3 crit√®res:</p>
<ul>
<li><em>Complexit√©</em>: C&rsquo;est souvent un bon moyen pour aider √† estimer le temps qui sera n√©cessaire pour la mise en oeuvre.</li>
<li><em>Risque</em>: Notre but, comme explicit√© dans ma d√©finition, est de ne pas d√©grader la production, mais toute action √† sa part de risque, surtout lors d&rsquo;une bascule d&rsquo;un morceau d&rsquo;architecture √† une autre, ou bien lors de la r√©duction du type d&rsquo;une Instance.</li>
<li><em>Economies attendues</em>: En valeur absolue bien souvent, et √† mettre en perspective avec les deux autres crit√®res. Il peut √™tre pertinent de faire une action simple, sans risque qui fait √©conomiser $100 plut√¥t qu&rsquo;une refonte compliqu√©e qui fera gagner $200 mais demandera 10JH par ailleurs (rappelez-vous, les co√ªts <em>Indirects</em>).</li>
</ul>
<p>Lorsque l&rsquo;audit <em>FinOps</em> est pour un client tiers, cela sera d&rsquo;autant plus important de lui permettre d'√©valuer les actions qu&rsquo;il voudra mener ou faire mener, lui seul ayant les cordons de sa bourse.</p>
<h3 id="identifier-et-supprimer-les-g√¢chis">Identifier et supprimer les g√¢chis</h3>
<p>La premi√®re action √† laquelle on pense, est bien √©videmment de r√©duire les g√¢chis. La flexibilit√© du <em>Cloud</em> amenant souvent √† cr√©er puis laisser tra√Æner des ressources dans un coin.</p>
<p>Voici une liste de quelques g√¢chis communs:</p>
<ul>
<li><em>Snapshots anciens</em>: Plusieurs cas de figures, soit ce sont des <em>Snapshots</em> pour des <em>AMI</em> obsol√®tes, soit de volumes <em>EBS</em> n&rsquo;existant plus. Il se peut que ce soit de vieux <em>Snapshots</em> d&rsquo;<em>EBS</em> encore en fonctionnement, dans ce cas, comme ils sont sauvegard√©s de mani√®re incr√©mentale, leurs suppressions entra√Ænera un gain moins important sur la facture, les plus r√©cents ayant toujours besoin d&rsquo;une r√©f√©rence.</li>
<li><em>AMI Anciennes</em>: Sauf si cela s&rsquo;av√®re vraiment n√©cessaire, il n&rsquo;est pas utile de garder de vieilles <em>AMI</em>, avec des syst√®mes et des paquets obsol√®tes. Leurs suppressions ne font rien gagner √† proprement parl√©, mais lib√®rent des <em>Snapshots</em> qui eux peuvent ensuite √™tre supprim√©s.</li>
<li><em>EIP d√©tach√©es</em>: Le gain est minime, mais si vraiment elles ne servent √† rien, autant les lib√©rer.</li>
<li><em>EBS d√©tach√©s</em>: Cela vient souvent de la suppression d&rsquo;<em>Instances</em> sans suppression des volumes qui les utilisaient. Si en plus il y avait de l&rsquo;<em>AutoScaling</em> d&rsquo;actif, les volumes peuvent vite monter.</li>
<li><em>EBS attach√©s mais sans IO</em>: Le coup classique du volume mont√© sur <code>/logs</code> mais o√π aucune application n'√©crit dedans.</li>
<li><em>ELB/ALB/NLB sans Instance ou sans requ√™te</em>: Il arrivent que des <code>xLB</code> ne pointent vers rien, ou bien que les <em>Instances</em> derri√®res soient <em>Unhealthy</em> depuis tr√®s longtemps, sans aucun impact par ailleurs.</li>
<li><em>EC2/RDS dans des anciens types</em>: A chaque nouvelle famille sortie par <em>AWS</em>, les prix sont plus faibles, pour parfois de meilleures performances ou options.</li>
<li><em>EC2 stopp√©es depuis longtemps</em>: Le <em>compute</em> n&rsquo;est pas pay√© dans ce cas, seul le stockage, cela peut √™tre l√©gitime ou non. A vous de voir.</li>
<li><em>Buckets S3 avec des objets de type Reduced Redundancy Storage Class</em>: AWS a d√©pr√©ci√© ce type d&rsquo;objet, en le rendant l√©g√®rement plus ch√®re d&rsquo;un milli√®me que le type <em>Standard</em>, sur des Po voire To, cela  vite (histoire v√©cue avec une plateforme de streaming de musique)</li>
<li><em>Buckets S3 Buckets qui sont Publics mais pas derri√®re une distribution CloudFront</em>: Rien que le fait de sortir sur Internet √† travers une distribution <em>Cloudfront</em> r√©duit les co√ªts de bande passante, cache activ√© ou non. Ceci est valable dans tous les cas, devant <code>xLB</code> ou <code>EC2</code>.</li>
<li><em>RDS sans connexion depuis longtemps</em>: Si la base ne sert que de temps en temps, il est toujours possible de l'√©teindre (pour 7j maximum, ensuite il faut √©teindre de nouveau).</li>
<li><em>RDS utilisant du PIOPS inutile</em>: Pour chaque GB de <em>GP2/3</em>, <em>AWS</em> assure un plancher de 3 IOPS, ce qui implique qu&rsquo;avec 350GB, vous avez plus (1050 IOPS) que les 1000 IOPS demand√©s √† √™tre pay√©s en minimum pour le stockage <em>PIOPS</em>, et ce pour beaucoup moins cher.</li>
</ul>
<p>Pour vous aider √† identifier ces √©l√©ments, l&rsquo;<em>API</em> et les m√©triques en votre possession seront tr√®s utiles.</p>
<h3 id="utiliser-correctement-les-ressources">Utiliser correctement les ressources</h3>
<h4 id="les-ressources-manag√©es">Les ressources manag√©es</h4>
<p>Avec l&rsquo;av√®nement du <em>Cloud</em>, sa souplesse et sa rapidit√© pour obtenir des ressources, on en vient presque √† oublier les r√©flexes de nos pr√©d√©cesseurs, contraints √† tirer jusqu'√† la derni√®re goutte de s√®ve des machines achet√©es pour plusieurs ann√©es.
Je crois fermement, qu&rsquo;avant d&rsquo;entamer des changements de type, surtout lors de <em>Scale Up</em>  (augmentation du type), il faut travailler au niveau de l&rsquo;<em>OS</em> et des applications pour obtenir le maximum. Tout r√©soudre par de l&rsquo;infra n&rsquo;a jamais √©t√© pertinent (le fameux plus de RAM, toujours plus de RAM, au lieu de traiter la fuite m√©moire).</p>
<h4 id="los-et-les-applications">L&rsquo;OS et les Applications</h4>
<p>Dans le cas des ressources manag√©es, surtout <em>RDS</em>, de tr√®s nombreux r√©glages sont √† disposition pour param√©trer les moteurs (taille des <em>buffers</em>, allocation de tables temporaires, nombre max de connexions, etc). Les ajuster au r√©el besoin m√©tier peut parfois changer du tout au tout les performances.</p>
<p>Pour les EC2, c&rsquo;est encore plus vrai, car on peut jouer sur bien plus de r√©glages comme:</p>
<ul>
<li>les <em>param√®tres sysctl</em>: Tous les <em>OS Unix-Like</em> permettent de r√©gler des param√®tres du <em>kernel</em>, dont beaucoup de limites. En ajustant ces valeurs, on peut souvent repousser les capacit√©s utilisables.</li>
<li>les <em>configurations des applications</em>: La majorit√© des applications, surtout dans le monde du <em>Web OpenSource</em>, permettent d'√™tre configur√©es jusqu&rsquo;au plus petit d√©tails pour assurer leurs charges (<em>worker_processes</em> ou <em>keepalives</em> pour <em>Nginx</em> par exemple).</li>
</ul>
<h4 id="compiler-ses-binaires">Compiler ses binaires</h4>
<p>Une autre option, bien moins r√©pandue, car plus difficile √† mettre en oeuvre, est le fait d&rsquo;utiliser des binaires compil√©s pour l&rsquo;architecture <em>CPU</em> de l&rsquo;<em>EC2</em> utilis√©e. Cela peut para√Ætre farfelu, surtout que cela apporte une grande complexit√© et sort totalement du cadre des gestionnaires de paquets si pratiques. Mais apr√®s tout, utiliser des binaires compil√©s en dehors de toute arborescence, c&rsquo;est une chose tr√®s r√©pandue, et cela s&rsquo;appelle un <em>Container</em> üòâ. AWS fournit pour chaque type d&rsquo;<em>Instance</em> le mod√®le de <em>CPU</em> associ√©, √† votre charge de trouver les bons <em>flags</em> √† utiliser pour la compilation, et de penser √† les modifier √† chaque changement de type (par un exemple, un rendu <em>Blender</em> via le <em>CPU</em> peut gagner jusqu'√† 30% de temps [du v√©cu], imaginez pour la capacit√© de traitements de requ√™tes par un <em>Apache</em> ou <em>Nginx/PHP-FPM</em>).</p>
<h3 id="utiliser-les-services-manag√©s">Utiliser les services manag√©s</h3>
<p>Utiliser des services manag√©s a un co√ªt, c&rsquo;est ind√©niable, mais ils sont √† relativiser et √† mettre en perspective avec les co√ªts <em>Indirects</em>. Entre un <em>PostgreSQL</em> manag√© et un <em>PostgreSQL</em> install√© √† la main sur un serveur lou√©, il se peut que la solution du <em>Cloud Provider</em> soit plus ch√®re, mais si vous rajoutez dans votre solution maison les co√ªts financiers et humains pour la gestion des backups, des possibles restaurations, de la haute disponibilit√©, etc, sans avoir en plus forc√©ment la capacit√© de changer la taille de la machine ou agrandir son stockage, la balance ne penche plus du m√™me c√¥t√©. Encore une fois, s&rsquo;arr√™ter uniquement aux co√ªts mat√©riels (qui se rattachent aux co√ªts <em>Directs</em>) et ne pas prendre l&rsquo;ensemble du p√©rim√®tre financier, peut s&rsquo;av√©rer contre-productif.</p>
<h3 id="mettre-en-place-des-outils-des-proc√©dures-des-formations">Mettre en place des outils, des proc√©dures, des formations</h3>
<p>Je conseille g√©n√©ralement de commencer par tout faire manuellement, que ce soit l&rsquo;analyse des co√ªts dans le <em>Cost Explorer</em>, la recherche des g√¢chis ou l&rsquo;estimation des √©conomies possibles. Cela dans le but de vraiment comprendre comment les choses fonctionnent et de pouvoir rep√©rer d&rsquo;un coup d&rsquo;oeil des axes d&rsquo;am√©liorations une fois que l&rsquo;habitude est fa√Æte.
Une fois rod√©, il est temps de mettre en place des proc√©dures, et si possible des outils automatis√©s pour limiter les d√©rives dans le temps. L&rsquo;automatisation des proc√©dures de nettoyage et d&rsquo;extinction des environnements en dehors des heures ouvr√©es sont des grands classiques, on trouve de nombreux exemples sur le net.
Comme √©voqu√© plus haut, c&rsquo;est √† ce niveau que les alertes de <em>Budget</em> peuvent aussi apporter leurs aides, m√™me si elles peuvent souvent s&rsquo;av√©rer trop rigides (une p√©riode de soldes peut exploser les compteurs par rapport au mois d&rsquo;avant, sans que cela soit inqui√©tant, bien au contraire).
Un volet √† ne pas n√©gliger √† cette √©tape (√† toutes en fait), est de former les √©quipes (chez soi ou chez son client), √† ce qu&rsquo;est le <em>FinOps</em>, ce qu&rsquo;il apporte et sur les proc√©dures en cours dans l&rsquo;entreprise qui font partie de son processus.</p>
<h3 id="architecturer-pour-r√©duire-les-co√ªts">Architecturer pour r√©duire les co√ªts</h3>
<p>C&rsquo;est la m√©thode la plus complexe, mais souvent la plus efficace et gratifiante, la refonte. Les <em>Cloud Providers</em> sortent en permanence de nouvelles fonctionnalit√©s et nouveaux services, ce qui est impossible aujourd&rsquo;hui ne le sera possiblement plus dans 1 ou 2 ans. Int√©grer le <em>FinOps</em> lors de la conception d&rsquo;une plateforme est important pour √™tre efficient, mais cela l&rsquo;est encore plus lors des refontes, qui peuvent souvent √™tre dict√©es pour des raisons de rationalisation et/ou d'√©conomies. Cela est d&rsquo;autant plus pertinent que vous avez alors une vraie exp√©rience du comportement de votre plateforme, de ses besoins et contraintes.</p>
<p>On peut envisager dans le cas d&rsquo;une refonte de:</p>
<ul>
<li>migrer certaines fonctions dans <em>Lambda</em></li>
<li>utiliser <em>DynamoDB</em> en base <em>NoSQL</em></li>
<li>utiliser des <em>ALB</em> devant les <em>Lambda</em> et non des <em>API Gateway</em></li>
</ul>
<p>Il faut garder √† l&rsquo;esprit encore une fois, que toutes les actions ont des co√ªts <em>Indirects</em> (JH pour migrer le code d&rsquo;une solution technique √† une autre, formations, etc), et peuvent vous &ldquo;verrouiller&rdquo; chez un <em>Cloud Provider</em>, on touche l√†, √† la politique de l&rsquo;entreprise.</p>
<h3 id="politiques-de-scale-inout">Politiques de Scale In/Out</h3>
<p>La capacit√© d&rsquo;adapter la flotte de machines √† la charge est une fonctionnalit√© de base, c&rsquo;est presque la raison premi√®re de l&rsquo;existence du <em>Cloud</em>. Avec le temps, que ce soit en natif ou via des fonctions externes, on peut piloter les groupes d&rsquo;<em>AutoScaling</em> pour faire beaucoup de choses comme:</p>
<ul>
<li>Retirer tout ou partie des machines en dehors des heures ouvr√©es</li>
<li>Changer la taille des <em>Instances</em> en fonction des p√©riodes</li>
<li><em>Scale In/Out</em> (ajouter/retirer) en fonction de m√©triques m√©tiers et non juste le <em>CPU</em> (qui est rarement une m√©trique pertinente, je le rappelle)</li>
</ul>
<h3 id="r√©servations--saving-plans">R√©servations / Saving Plans</h3>
<p>Si vous √™tes pr√™t √† vous engager sur du long terme (1 ou 3 ans), r√©server des ressources est le moyen le plus direct d&rsquo;obtenir au moins 30% d'√©conomie (avec versement d&rsquo;un account ou non) sur des services tels que:</p>
<ul>
<li><em>EC2</em></li>
<li><em>RDS</em></li>
<li><em>Elasticache</em></li>
<li><em>DynamoDB</em></li>
</ul>
<p>Les cas de <em>DynamoDB</em> et <em>Elasticache</em> sont un peu particulier, le premier demandant de r√©server des capacit√©s en <em>Read/Write</em> et non des ressources &ldquo;mat√©rielles&rdquo; et le second imposant un acompte dans tous les cas.</p>
<p>Pour rappel, les r√©servations fonctionnent avec des unit√©s de temps, il ne s&rsquo;agit pas de machines avec une √©tiquette √† son nom dans le datacenter <em>AWS</em>.</p>
<p>Prenons un exemple pour expliciter les choses.</p>
<p>Imaginons que vous r√©serviez pour 1 an, pour de l&rsquo;<em>EC2</em>, 1 <em>&ldquo;Instance&rdquo;</em> <code>m5.xlarge</code>. Vous obtenez donc, 4 unit√©s (cf ce <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/apply_ri.html">tableau</a>) par mois dans la famille <code>m5</code>. En prenant qu&rsquo;un mois fait en moyenne 732h, vous aurez donc le droit au prix r√©duit pour:</p>
<ul>
<li>732h de <code>m5.xlarge</code></li>
<li>1464h de <code>m5.large</code> (soit 2 Instances)</li>
<li>366h de <code>m5.2xlarge</code> (soit 1 Instance allum√©e la moiti√© du mois)</li>
</ul>
<p>Les unit√©s sont circonscrites √† une famille, c&rsquo;est exactement le m√™me cas pour les <em>Saving Plans</em> de type <em>EC2 Instance</em> (les √©conomies sont √† la virgule pr√®s les m√™mes que pour les R√©servations). Si vous voulez ne pas √™tre contraint, et ne raisonner qu&rsquo;en termes d&rsquo;unit√©s de calcul et non de &ldquo;famille&rdquo;, les <em>Saving Plans</em> de type <em>Compute</em>, sont la nouvelle m√©thode pour proc√©der √† des r√©servations chez <em>AWS</em>, peu importe la famille ou le type. Les r√©ductions sur le <em>Compute</em> s&rsquo;appliquant peu importe le type, cela vous permet de changer de famille quand vous le souhaitez. Cela vient cependant avec une √©conomie moindre.</p>
<h3 id="spot-instances">Spot Instances</h3>
<p><em>AWS</em> met √† disposition son stock d&rsquo;invendus (en quelque sorte) √† prix cass√© (jusqu'√† -70%), ce qu&rsquo;ils appellent des <em>Spot Instances</em>. Le principe est simple, vous d√©finissez un prix maximal pour lequel vous √™tes pr√™t √† payer, et tant que le prix courant est inf√©rieur et qu&rsquo;<em>AWS</em> a du stock, vous √™tes susceptible d&rsquo;avoir votre <em>Instance</em>. Si un des crit√®res n&rsquo;est plus respect√©, <em>AWS</em> vous pr√©vient 2min avant de vous retirer l&rsquo;<em>Instance</em>. Pour mitiger les risques, vous avez la possibilit√© de vous faire des flottes, c&rsquo;est-√†-dire des groupes d&rsquo;<em>Instances</em> de diff√©rents types.</p>
<p>C&rsquo;est un moyen extr√™mement puissant pour faire des √©conomies, √† condition que l&rsquo;usage que vous en fa√Ætes tol√®re de perdre des noeuds, c&rsquo;est donc tr√®s souvent utilis√© pour faire des tests au sein d&rsquo;une <em>CI</em>, par exemple.</p>
<p>Un autre aspect √† prendre en compte et qui permet de limiter encore plus les risques, c&rsquo;est de mixer des <em>Instances</em> <em>On-Demand</em> (pay√©es au prix public annonc√©) et des <em>Instances</em> <em>Spot</em>. C&rsquo;est d√©sormais possible avec les <em>Launch Templates</em> qui d√©finissent comment doivent √™tre les <em>Instances</em>  d&rsquo;un groupe d&rsquo;<em>Auto-Scaling</em>. Vous d√©finissez le nombre d&rsquo;<em>Instances</em> <em>On-Demand</em> qui constitueront votre base, puis le pourcentage d&rsquo;<em>On-Demand</em> au dessus cette base par rapport aux <em>Instances</em> <em>Spot</em>. Si votre base <em>On-Demand</em> correspond √† vos r√©servations, l'√©conomie est encore plus importante avec un risque contr√¥l√©.</p>
<h3 id="organisation-des-comptes">Organisation des comptes</h3>
<p>La bonne pratique est d&rsquo;isoler les environnements (prod, staging, etc) dans des comptes <em>AWS</em> diff√©rents. Isoler les comptes les uns des autres permet, entre autres:</p>
<ul>
<li>d&rsquo;assurer l'√©tanch√©it√© pour la s√©curit√©</li>
<li>de bien s√©parer les co√ªts, ce qui facilite les analyses (un flux sortant est un flux sortant, <em>AWS</em> ne vous dira pas de quelle <em>VPC</em> pr√©cis√©ment il vient, difficile de refacturer entre <em>cost centers</em> dans ce cas)</li>
</ul>
<p>A c√¥t√© de cela il est tr√®s int√©ressant de regrouper tous ces comptes au sein d&rsquo;une seule organisation, avec un compte payeur identifi√© (appel√© compte consolidant) et ne poss√©dant aucune ressource (pour simplifier les analyses, de cette mani√®re il n&rsquo;appara√Ætra pas 2 fois, en tant que compte et compte consolidant).</p>
<p>Il y a plusieurs avantages √† faire cela, le compte payeur agr√©geant la totalit√© de la facture:</p>
<ul>
<li>les r√©servations sont remont√©es au niveau du compte consolidant (sauf param√©trage volontaire), ce qui implique que les unit√©s non utilis√©es d&rsquo;un c√¥t√© peuvent l'√™tre de l&rsquo;autre, vous ne payez pas pour rien</li>
<li>vous b√©n√©ficiez des tarifs sur les volumes (au sens de quantit√©), ce qu&rsquo;on appelle les <em>Blended Costs</em>.</li>
<li><em>AWS</em> fournit une facture r√©capitulative de l&rsquo;ensemble des frais, ce qui fera plaisir au service comptable qui n&rsquo;aura pas √† g√©rer N pdf.</li>
</ul>
<p>Les <em>Blended Costs</em> sont une mani√®re d&rsquo;agr√©ger tous les volumes de certains services et de b√©n√©ficier ainsi des tranches de prix inf√©rieures.</p>
<p>Prenons comme exemple <em>S3</em> pour expliciter la chose.</p>
<blockquote>
<p>Imaginons deux comptes li√©s A et B √† un compte consolidant Z.
Les usages S3 sont respectivement:</p>
<ul>
<li>50To en eu-west-3 pour le compte A</li>
<li>30To en eu-west-3 pour le compte B</li>
</ul>
<p>Si les comptes √©taient factur√©s s√©par√©ment, il devraient:</p>
<ul>
<li>compte A: <code>30To x 0,024$/GB = $720</code></li>
<li>compte B: <code>40To x 0,024$/GB = $960</code></li>
<li>total: <code>$1680</code></li>
</ul>
<p>Avec les Blended Costs, le compte Z consolidant le tout paiera en fait:</p>
<ul>
<li><code>50To x 0,024$/GB + 20To x 0,023$/GB = $1620</code></li>
</ul>
<p>On a donc une √©conomie de $60, sans aucune action autre qu&rsquo;avoir li√© les comptes A et B √† Z.</p>
</blockquote>
<p>(voir <a href="https://aws.amazon.com/fr/s3/pricing/">ICI</a> pour les tarifs de <em>S3</em>)</p>
<h2 id="tags">Tags</h2>
<p>On touche au nerf de la guerre, les <em>Tags</em>. Il est essentiel pour comprendre les co√ªts, voire de les anticiper, de cat√©goriser au maximum les choses, et cela passe par le tagging des ressources qui le peuvent (on ne peut pas tagger les flux r√©seau, par exemple).</p>
<p>Voici quelques tags utiles:</p>
<ul>
<li><code>environnement</code></li>
<li><code>project</code></li>
<li><code>businessUnit</code></li>
<li><code>costCenter</code></li>
<li><code>scope</code></li>
<li><code>team</code></li>
</ul>
<p>Il y a un point tr√®s important √† savoir, les tags sont sensibles √† la casse au niveau des cl√©s et des valeurs, il faut donc √™tre vigilant pour ne pas avoir des <code>prod</code>, <code>Prod</code>, <code>production</code>, etc, qui repr√©sentent la m√™me valeur mais cr√©ent du bruit, voire peuvent cacher certaines ressources de vos rapports.</p>
<p>Pour vous aider dans votre rattrapage, dans le cas o√π vous avez des ressources cr√©√©es √† la main, <em>AWS</em> fournit un outil au final assez m√©connu, le <a href="https://docs.aws.amazon.com/ARG/latest/userguide/tag-editor.html"><em>Tag Editor</em></a>.</p>
<h2 id="conclusion">Conclusion</h2>
<p>Cet article n&rsquo;est finalement qu&rsquo;une √©bauche de tout ce qu&rsquo;on peut faire sans vraiment rentrer dans les d√©tails de comment on le fait. Il ne repr√©sente qu&rsquo;une synth√®se de mes r√©flexions, dont les conclusions sont s√ªrement discutables (et peut-√™tre obsol√®tes maintenant, le monde du <em>Cloud</em> bougeant tellement vite). Vous avez s√ªrement remarqu√© qu&rsquo;il y a un grand absent dans cet article, quid du <em>FinOps</em> quand on utilise <em>Kubernetes</em>? A l'√©poque o√π je faisais encore des audits <em>FinOps</em>, bien qu&rsquo;utilisant <em>K8S</em> en production, je n&rsquo;avais jamais eu √† creuser s√©rieusement la question. Je pense cependant que les principes g√©n√©raux que j&rsquo;ai mentionn√©s peuvent s&rsquo;appliquer en partie, dans le cas d&rsquo;un environnement avec des ressources mutualis√©es comme l&rsquo;est <em>Kubernetes</em>.</p>
<p>Merci d&rsquo;avoir lu jusqu&rsquo;au bout ce long article, et j&rsquo;esp√®re qu&rsquo;il aura √©t√© utile √† quelqu&rsquo;un, il m&rsquo;a au moins permis de sortir de ma t√™te quelque chose qui y tra√Ænait depuis longtemps.</p>
<p><em>Enjoy</em></p>

  </div>
  <footer>
    <ul class="stats">
  
    
    
      <li class="categories">
        <ul>
          
            
            <li><a class="article-category-link" href="https://thomas.labarussias.fr/categories/cloud">cloud</a></li>
          
            
            <li><a class="article-category-link" href="https://thomas.labarussias.fr/categories/finops">finops</a></li>
          
        </ul>
      </li>
    
  
  
</ul>

  </footer>
</article>
<article class="post">
<div id="comments">
    <script src="https://utteranc.es/client.js"
        repo='issif/issif.github.io-comments'
        issue-term="pathname"
        theme='github-light'
        crossorigin="anonymous"
        async>
    </script>
</div>
</article>

<div class="pagination">
  
    <a href="/blog/cncf-meetup-paris-mars-2021/" class="button big previous"><i class="fas fa-angle-left"></i> Falco: D√©tection et r√©action aux menaces dans Kubernetes</a>
  
  
</div>


      </main>
      <section id="site-sidebar">
  
    <section id="recent-posts">
      <header>
        <h1>Posts r√©cents</h1>
      </header>
      
      <article class="mini-post">
        <section>
          

        </section>
        <header>
          <h1><a href="/blog/finops/">Le FinOps</a></h1>
          <time class="published" datetime="">17-06-2021</time>
        </header>
      </article>
      
      <article class="mini-post">
        <section>
          
<a href="/blog/cncf-meetup-paris-mars-2021/" class="image featured">
  <img src="/img/main/falco-feature.png" alt="falco feature">
</a>


        </section>
        <header>
          <h1><a href="/blog/cncf-meetup-paris-mars-2021/">Falco: D√©tection et r√©action aux menaces dans Kubernetes</a></h1>
          <time class="published" datetime="">06-04-2021</time>
        </header>
      </article>
      
      <article class="mini-post">
        <section>
          

        </section>
        <header>
          <h1><a href="/blog/monitorer-golang-app-local/">Monitorer son application Go en local</a></h1>
          <time class="published" datetime="">27-06-2020</time>
        </header>
      </article>
      
      
        <a href="/blog/" class="button">Voir plus</a>
      
    </section>
  

  
    
      <section id="categories">
        <header>
          <h1><a href="/categories">Cat√©gories</a></h1>
        </header>
        <ul>
          
            
          
          
          <li>
            
              <a href="/categories/go/">go<span class="count">9</span></a>
            
          
          <li>
            
              <a href="/categories/falco/">falco<span class="count">8</span></a>
            
          
          <li>
            
              <a href="/categories/s%C3%A9curit%C3%A9/">s√©curit√©<span class="count">8</span></a>
            
          
          <li>
            
              <a href="/categories/chart/">chart<span class="count">1</span></a>
            
          
          <li>
            
              <a href="/categories/cloud/">cloud<span class="count">1</span></a>
            
          
          <li>
            
              <a href="/categories/finops/">finops<span class="count">1</span></a>
            
          
          <li>
            
              <a href="/categories/hugo/">hugo<span class="count">1</span></a>
            
          
          <li>
            
              <a href="/categories/javascript/">javascript<span class="count">1</span></a>
            
          
          <li>
            
              <a href="/categories/kubernetes/">kubernetes<span class="count">1</span></a>
            
          
          <li>
            
              <a href="/categories/monitoring/">monitoring<span class="count">1</span></a>
            
          
          <li>
            
              <a href="/categories/traefik/">traefik<span class="count">1</span></a>
            
          
          <li>
            
              <a href="/categories/web/">web<span class="count">1</span></a>
            
          
          </li>
        </ul>
      </section>
    
  

  <section id="mini-bio">
    <header>
      <h1>A propos</h1>
    </header>
    <p>Du Go, de l'AWS et autres par un SRE/FinOps</p>
    <footer>
      <a href="/about" class="button">En savoir plus</a>
    </footer>
  </section>
</section>

      <footer id="site-footer">
  
  <p class="copyright">
    
      &copy; 2021
      
        Issif
      
    . <br>
    Th√®me : <a href='https://github.com/pacollins/hugo-future-imperfect-slim' target='_blank' rel='noopener'>Hugo Future Imperfect Slim</a><br>Un <a href='https://html5up.net/future-imperfect' target='_blank' rel='noopener'>portage de HTML5 UP</a> | Propuls√© par <a href='https://gohugo.io/' title='0.64.1' target='_blank' rel='noopener'>Hugo</a>
  </p>
</footer>
<a id="back-to-top" href="#" class="fas fa-arrow-up fa-2x"></a>
<script data-goatcounter="https://stats.labarussias.fr/count"
        async src="//stats.labarussias.fr/count.js"></script>

      
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/htmlbars.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/scss.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/javascript.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/go.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/bash.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>


  
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/skel/3.0.1/skel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.3.5/jquery.fancybox.min.js"></script>
  <script src=/js/util.js></script>
  <script src=/js/main.js></script>
  <script src=/js/add-on.js></script>
  



    </div>
  </body>
</html>
